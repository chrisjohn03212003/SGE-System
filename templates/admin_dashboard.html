<!-- templates/admin_dashboard.html -->
{% extends "base.html" %} {% block title %}Admin Dashboard - Student Election
System{% endblock %} {% block content %}
<div class="container">
  <div class="header">
    <h1>üë®‚Äçüíº Admin Dashboard</h1>
  </div>

  <nav class="nav">
    <ul>
      <li>
        <a href="#" onclick="showSection('election-settings')"
          >Election Settings</a
        >
      </li>
      <li><a href="#" onclick="showSection('students')">Manage Students</a></li>
      <li>
        <a href="#" onclick="showSection('positions')">Manage Positions</a>
      </li>
      <li>
        <a href="#" onclick="showSection('candidates')">Manage Candidates</a>
      </li>
      <li><a href="#" onclick="showSection('results')">View Results</a></li>
      <li><a href="/logout">Logout</a></li>
    </ul>
  </nav>

  <!-- Election Settings Section -->
  <div id="election-settings" class="section card">
    <h2>‚öôÔ∏è Election Settings</h2>
    <form id="electionSettingsForm">
      <div class="form-group">
        <label for="election_title">Election Title:</label>
        <input
          type="text"
          id="election_title"
          name="title"
          class="form-control"
          placeholder="Student Government Election 2025"
        />
      </div>
      <button type="submit" class="btn">Update Settings</button>
    </form>
  </div>

  <!-- Students Management Section -->
  <div id="students" class="section card" style="display: none">
    <h2>üë• Manage Students</h2>

    <button
      onclick="showModal('addStudentModal')"
      class="btn"
      style="margin-bottom: 20px"
    >
      Add New Student
    </button>

    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Student ID</th>
            <th>Name</th>
            <th>Age</th>
            <th>Voting Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="studentsTableBody">
          <!-- Students will be loaded here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Positions Management Section -->
  <div id="positions" class="section card" style="display: none">
    <h2>üìã Manage Positions</h2>

    <button
      onclick="showModal('addPositionModal')"
      class="btn"
      style="margin-bottom: 20px"
    >
      Add New Position
    </button>

    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Position Name</th>
            <th>Order</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="positionsTableBody">
          <!-- Positions will be loaded here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Candidates Management Section -->
  <div id="candidates" class="section card" style="display: none">
    <h2>üèÜ Manage Candidates</h2>

    <button
      onclick="showModal('addCandidateModal')"
      class="btn"
      style="margin-bottom: 20px"
    >
      Add New Candidate
    </button>

    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Position</th>
            <th>Platform</th>
            <th>Votes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="candidatesTableBody">
          <!-- Candidates will be loaded here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Results Section -->
  <div id="results" class="section card" style="display: none">
    <h2>üìä Election Results</h2>
    <button onclick="loadResults()" class="btn" style="margin-bottom: 20px">
      Refresh Results
    </button>
    <div id="resultsContainer">
      <!-- Results will be loaded here -->
    </div>
  </div>
</div>

<!-- Modals -->
<!-- Add Student Modal -->
<div id="addStudentModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="hideModal('addStudentModal')">&times;</span>
    <h3>Add New Student</h3>
    <form id="addStudentForm">
      <div class="form-group">
        <label for="student_id_input">Student ID:</label>
        <input
          type="text"
          id="student_id_input"
          name="student_id"
          class="form-control"
          autocomplete="off" required
        />
      </div>
      <div class="form-group">
        <label for="student_name">Name:</label>
        <input
          type="text"
          id="student_name"
          name="name"
          class="form-control"
          autocomplete="off" required
        />
      </div>
      <div class="form-group">
        <label for="student_age">Age:</label>
        <input
          type="number"
          id="student_age"
          name="age"
          class="form-control"
          min="16"
          max="25"
          autocomplete="off" required
        />
      </div>
      <div class="form-group">
        <label for="student_password">Password:</label>
        <input
          type="password"
          id="student_password"
          name="password"
          class="form-control"
          autocomplete="off" required
        />
      </div>
      <button type="submit" class="btn">Add Student</button>
    </form>
  </div>
</div>

<!-- Add Position Modal -->
<div id="addPositionModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="hideModal('addPositionModal')">&times;</span>
    <h3>Add New Position</h3>
    <form id="addPositionForm">
      <div class="form-group">
        <label for="position_name">Position Name:</label>
        <input
          type="text"
          id="position_name"
          name="name"
          class="form-control"
          placeholder="e.g., President, Vice President"
          autocomplete="off" required
        />
      </div>
      <div class="form-group">
        <label for="position_order">Display Order:</label>
        <input
          type="number"
          id="position_order"
          name="order"
          class="form-control"
          min="1"
          placeholder="1"
          autocomplete="off" required
        />
      </div>
      <button type="submit" class="btn">Add Position</button>
    </form>
  </div>
</div>

<!-- Add Candidate Modal -->
<div id="addCandidateModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="hideModal('addCandidateModal')">&times;</span>
    <h3>Add New Candidate</h3>
    <form id="addCandidateForm">
      <div class="form-group">
        <label for="candidate_name">Candidate Name:</label>
        <input
          type="text"
          id="candidate_name"
          name="name"
          class="form-control"
          autocomplete="off" required
        />
      </div>
      <div class="form-group">
        <label for="candidate_position">Position:</label>
        <select
          id="candidate_position"
          name="position_id"
          class="form-control"
          autocomplete="off" required
        >
          <option value="">Select Position</option>
        </select>
      </div>
      <div class="form-group">
        <label for="candidate_platform">Platform/Description:</label>
        <textarea
          id="candidate_platform"
          name="platform"
          class="form-control"
          rows="3"
          placeholder="Candidate's platform or description"
        ></textarea>
      </div>
      <button type="submit" class="btn">Add Candidate</button>
    </form>
  </div>
</div>

<script>
  let currentSection = "election-settings";

  // Show specific section
  function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll(".section").forEach((section) => {
      section.style.display = "none";
    });

    // Show selected section
    document.getElementById(sectionId).style.display = "block";
    currentSection = sectionId;

    // Load data for the section
    switch (sectionId) {
      case "election-settings":
        loadElectionSettings();
        break;
      case "students":
        loadStudents();
        break;
      case "positions":
        loadPositions();
        break;
      case "candidates":
        loadCandidates();
        loadPositionsForSelect();
        break;
      case "results":
        loadResults();
        break;
    }
  }

  // Load election settings
  async function loadElectionSettings() {
    try {
      const response = await fetch("/api/election-settings");
      const data = await response.json();
      document.getElementById("election_title").value =
        data.title || "Student Government Election";
    } catch (error) {
      console.error("Error loading election settings:", error);
    }
  }

  // Load students
  async function loadStudents() {
    try {
      const response = await fetch("/api/students");
      const students = await response.json();

      const tbody = document.getElementById("studentsTableBody");
      tbody.innerHTML = "";

      students.forEach((student) => {
        const row = document.createElement("tr");
        row.innerHTML = `
                <td>${student.student_id}</td>
                <td>${student.name}</td>
                <td>${student.age}</td>
                <td>
                    <span style="color: ${
                      student.has_voted ? "#28a745" : "#dc3545"
                    };">
                        ${student.has_voted ? "‚úÖ Voted" : "‚ùå Not Voted"}
                    </span>
                </td>
                <td>
                    <button onclick="deleteStudent('${
                      student.id
                    }')" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">
                        Delete
                    </button>
                </td>
            `;
        tbody.appendChild(row);
      });
    } catch (error) {
      console.error("Error loading students:", error);
    }
  }

  // Load positions
  async function loadPositions() {
    try {
      const response = await fetch("/api/positions");
      const positions = await response.json();

      const tbody = document.getElementById("positionsTableBody");
      tbody.innerHTML = "";

      positions.forEach((position) => {
        const row = document.createElement("tr");
        row.innerHTML = `
                <td>${position.name}</td>
                <td>${position.order}</td>
                <td>
                    <button onclick="deletePosition('${position.id}')" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">
                        Delete
                    </button>
                </td>
            `;
        tbody.appendChild(row);
      });
    } catch (error) {
      console.error("Error loading positions:", error);
    }
  }

  // Load candidates
  async function loadCandidates() {
    try {
      const [candidatesResponse, positionsResponse] = await Promise.all([
        fetch("/api/candidates"),
        fetch("/api/positions"),
      ]);

      const candidates = await candidatesResponse.json();
      const positions = await positionsResponse.json();

      // Create position lookup
      const positionLookup = {};
      positions.forEach((pos) => {
        positionLookup[pos.id] = pos.name;
      });

      const tbody = document.getElementById("candidatesTableBody");
      tbody.innerHTML = "";

      candidates.forEach((candidate) => {
        const row = document.createElement("tr");
        row.innerHTML = `
                <td>${candidate.name}</td>
                <td>${positionLookup[candidate.position_id] || "Unknown"}</td>
                <td>${candidate.platform || "No platform"}</td>
                <td><strong>${candidate.votes || 0}</strong></td>
                <td>
                    <button onclick="deleteCandidate('${
                      candidate.id
                    }')" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">
                        Delete
                    </button>
                </td>
            `;
        tbody.appendChild(row);
      });
    } catch (error) {
      console.error("Error loading candidates:", error);
    }
  }

  // Load positions for candidate select
  async function loadPositionsForSelect() {
    try {
      const response = await fetch("/api/positions");
      const positions = await response.json();

      const select = document.getElementById("candidate_position");
      select.innerHTML = '<option value="">Select Position</option>';

      positions.forEach((position) => {
        const option = document.createElement("option");
        option.value = position.id;
        option.textContent = position.name;
        select.appendChild(option);
      });
    } catch (error) {
      console.error("Error loading positions for select:", error);
    }
  }

  // Load results
  async function loadResults() {
    try {
      const response = await fetch("/api/results");
      const results = await response.json();

      const container = document.getElementById("resultsContainer");
      container.innerHTML = "";

      Object.keys(results).forEach((positionName) => {
        const positionResult = results[positionName];
        const positionDiv = document.createElement("div");
        positionDiv.className = "card";
        positionDiv.style.marginBottom = "20px";

        let candidatesList = "";
        positionResult.candidates.forEach((candidate, index) => {
          const isWinner = index === 0 && candidate.votes > 0;
          candidatesList += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; 
                         border-left: 4px solid ${
                           isWinner ? "#DAA520" : "#D2691E"
                         }; 
                         background: ${
                           isWinner ? "rgba(218, 165, 32, 0.1)" : "transparent"
                         }; 
                         margin: 5px 0;">
                        <span style="font-weight: ${
                          isWinner ? "bold" : "normal"
                        };">
                            ${isWinner ? "üèÜ " : ""}${candidate.name}
                        </span>
                        <span style="font-size: 18px; font-weight: bold; color: #8B4513;">
                            ${candidate.votes} votes
                        </span>
                    </div>
                `;
        });

        positionDiv.innerHTML = `
                <h3 style="color: #8B4513; margin-bottom: 15px;">${positionName}</h3>
                ${
                  candidatesList ||
                  '<p style="color: #666;">No candidates for this position</p>'
                }
            `;

        container.appendChild(positionDiv);
      });
    } catch (error) {
      console.error("Error loading results:", error);
    }
  }

  // Form submissions
  document
    .getElementById("electionSettingsForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const data = { title: formData.get("title") };

      try {
        const response = await fetch("/api/election-settings", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          showAlert("Election settings updated successfully!");
        } else {
          showAlert("Failed to update settings", "error");
        }
      } catch (error) {
        showAlert("Error: " + error.message, "error");
      }
    });

  document
    .getElementById("addStudentForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const data = {
        student_id: formData.get("student_id"),
        name: formData.get("name"),
        age: formData.get("age"),
        password: formData.get("password"),
      };

      try {
        const response = await fetch("/api/students", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          showAlert("Student added successfully!");
          hideModal("addStudentModal");
          e.target.reset();
          loadStudents();
        } else {
          const error = await response.json();
          showAlert(error.error || "Failed to add student", "error");
        }
      } catch (error) {
        showAlert("Error: " + error.message, "error");
      }
    });

  document
    .getElementById("addPositionForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const data = {
        name: formData.get("name"),
        order: formData.get("order"),
      };

      try {
        const response = await fetch("/api/positions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          showAlert("Position added successfully!");
          hideModal("addPositionModal");
          e.target.reset();
          loadPositions();
        } else {
          showAlert("Failed to add position", "error");
        }
      } catch (error) {
        showAlert("Error: " + error.message, "error");
      }
    });

  document
    .getElementById("addCandidateForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const data = {
        name: formData.get("name"),
        position_id: formData.get("position_id"),
        platform: formData.get("platform"),
      };

      try {
        const response = await fetch("/api/candidates", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          showAlert("Candidate added successfully!");
          hideModal("addCandidateModal");
          e.target.reset();
          loadCandidates();
        } else {
          showAlert("Failed to add candidate", "error");
        }
      } catch (error) {
        showAlert("Error: " + error.message, "error");
      }
    });

  // Delete functions
  async function deleteStudent(studentId) {
    if (confirm("Are you sure you want to delete this student?")) {
      try {
        const response = await fetch(`/api/students/${studentId}`, {
          method: "DELETE",
        });

        if (response.ok) {
          showAlert("Student deleted successfully!");
          loadStudents();
        } else {
          showAlert("Failed to delete student", "error");
        }
      } catch (error) {
        showAlert("Error: " + error.message, "error");
      }
    }
  }

  async function deletePosition(positionId) {
    if (
      confirm(
        "Are you sure you want to delete this position? This will also delete all candidates for this position."
      )
    ) {
      try {
        const response = await fetch(`/api/positions/${positionId}`, {
          method: "DELETE",
        });

        if (response.ok) {
          showAlert("Position deleted successfully!");
          loadPositions();
        } else {
          showAlert("Failed to delete position", "error");
        }
      } catch (error) {
        showAlert("Error: " + error.message, "error");
      }
    }
  }

  async function deleteCandidate(candidateId) {
    if (confirm("Are you sure you want to delete this candidate?")) {
      try {
        const response = await fetch(`/api/candidates/${candidateId}`, {
          method: "DELETE",
        });

        if (response.ok) {
          showAlert("Candidate deleted successfully!");
          loadCandidates();
        } else {
          showAlert("Failed to delete candidate", "error");
        }
      } catch (error) {
        showAlert("Error: " + error.message, "error");
      }
    }
  }

  // Load initial data
  loadElectionSettings();
</script>
{% endblock %}
